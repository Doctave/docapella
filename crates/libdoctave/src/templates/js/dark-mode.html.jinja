<script>
  const STORAGE_KEY = "darkModePreference";
  const EXPIRY_DAYS = 7;

  function savePreference(mode) {
    const preference = {
      value: mode,
      timestamp: Date.now(),
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(preference));
  }

  function getStoredPreference() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (!stored) return null;

      const preference = JSON.parse(stored);
      const now = Date.now();
      const expiryTime =
        preference.timestamp + EXPIRY_DAYS * 24 * 60 * 60 * 1000;

      if (now > expiryTime) {
        localStorage.removeItem(STORAGE_KEY);
        return null;
      }

      return preference.value;
    } catch (error) {
      localStorage.removeItem(STORAGE_KEY);
      return null;
    }
  }

  function toggleDarkMode() {
    const isDark = document.documentElement.classList.contains("dark");

    if (isDark) {
      document.documentElement.classList.remove("dark");
      savePreference("light");
    } else {
      document.documentElement.classList.add("dark");
      savePreference("dark");
    }
  }

  // Set up toggle buttons when DOM is ready
  document.addEventListener("DOMContentLoaded", function () {
    const toggleButtons = document.querySelectorAll('[data-dark-mode-toggle]');

    if (toggleButtons) {
      toggleButtons.forEach((toggleButton) => {
        toggleButton.addEventListener("click", toggleDarkMode);
      });
    }
  });

  // Only respond to system preference changes if no user preference is stored
  window
    .matchMedia("(prefers-color-scheme: dark)")
    .addEventListener("change", function (e) {
      const storedPreference = getStoredPreference();

      if (storedPreference === null) {
        if (e.matches) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
      }
    });
</script>
