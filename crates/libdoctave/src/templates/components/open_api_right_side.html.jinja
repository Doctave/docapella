{% from "components/markdown.html.jinja" import markdown %}

{# Check if we have any request examples at all #}
{%- set has_code_examples = operation.request_examples and operation.request_examples|length > 0 -%}
{%- set has_http_examples = operation.request_body and operation.request_body.media_types and operation.request_body.media_types[0].examples and operation.request_body.media_types[0].examples|length > 0 -%}


{# Only render if there are actually examples (conditional rendering like V2) #}
{% if has_code_examples or has_http_examples %}
<div class="open-api-request-examples">
  <h3 class="open-api-examples-title">Request examples</h3>
  
  <div class="open-api-examples-card">
    {# Code Examples Section #}
    {% if has_code_examples %}
      {%- set example_groups = operation.request_examples | groupby("group_name") -%}
      
      {% if example_groups|length > 1 %}
        {# Multiple groups - show group tabs #}
        <div x-data="{ activeGroup: '{{ example_groups[0][0] }}' }">
          <div class="open-api-examples-tabs-header">
            {% for group_name, examples in example_groups %}
              <button 
                :class="{ 'active': activeGroup === '{{ group_name }}' }" 
                @click="activeGroup = '{{ group_name }}'"
              >
                {{ group_name }}
              </button>
            {% endfor %}
          </div>

          {% for group_name, examples in example_groups %}
            <div x-show="activeGroup === '{{ group_name }}'"{% if not loop.first %} x-cloak{% endif %}>
              {% if examples|length > 1 %}
                <div class="open-api-examples-content" x-data="{ activeExample: '{{ examples[0].identifier }}' }">
                  <div class="open-api-example-selector">
                    <select x-model="activeExample">
                      {% for example in examples %}
                        <option value="{{ example.identifier }}">{{ example.name or example.language or example.summary or "Example" }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  {% for example in examples %}
                    <div x-show="activeExample === '{{ example.identifier }}'"{% if not loop.first %} x-cloak{% endif %}>
                      <div class="open-api-code-block">
                        <pre data-highlight="true" class="language-{{ example.language or 'json' }}">{{ example.value }}</pre>
                      </div>
                      {% if example.description_ast %}
                        <div class="open-api-example-description">
                          {{ markdown(example.description_ast, true) }}
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="open-api-examples-content">
                  <div class="open-api-code-block">
                    <pre data-highlight="true" class="language-{{ examples[0].language or 'json' }}">{{ examples[0].value }}</pre>
                  </div>
                  {% if examples[0].description_ast %}
                    <div class="open-api-example-description">
                      {{ markdown(examples[0].description_ast, true) }}
                    </div>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        {# Single group - no group tabs needed #}
        {%- set examples = example_groups[0][1] -%}
        {% if examples|length > 1 %}
          <div class="open-api-examples-content" x-data="{ activeExample: '{{ examples[0].identifier }}' }">
            <div class="open-api-example-selector">
              <select x-model="activeExample">
                {% for example in examples %}
                  <option value="{{ example.identifier }}">{{ example.name or example.language or example.summary or "Example" }}</option>
                {% endfor %}
              </select>
            </div>

            {% for example in examples %}
              <div x-show="activeExample === '{{ example.identifier }}'"{% if not loop.first %} x-cloak{% endif %}>
                <div class="open-api-code-block">
                  <pre data-highlight="true" class="language-{{ example.language or 'json' }}">{{ example.value }}</pre>
                </div>
                {% if example.description_ast %}
                  <div class="open-api-example-description">
                    {{ markdown(example.description_ast, true) }}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="open-api-examples-content">
            <div class="open-api-code-block">
              <pre data-highlight="true" class="language-{{ examples[0].language or 'json' }}">{{ examples[0].value }}</pre>
            </div>
            {% if examples[0].description_ast %}
              <div class="open-api-example-description">
                {{ markdown(examples[0].description_ast, true) }}
              </div>
            {% endif %}
          </div>
        {% endif %}
      {% endif %}
    {% endif %}

    {# HTTP Request Examples Section #}
    {% if has_http_examples %}
      {% if has_code_examples %}<div class="open-api-examples-separator"></div>{% endif %}
      
      {% if operation.request_body.media_types|length > 1 %}
        <div x-data="{ selectedMediaType: '{{ operation.request_body.media_types[0].name }}' }">
          <div class="open-api-example-selector">
            <select x-model="selectedMediaType">
              {% for media_type in operation.request_body.media_types %}
                {% if media_type.examples and media_type.examples|length > 0 %}
                  <option value="{{ media_type.name }}">{{ media_type.name }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          {% for media_type in operation.request_body.media_types %}
            {% if media_type.examples and media_type.examples|length > 0 %}
              <div x-show="selectedMediaType === '{{ media_type.name }}'"{% if not loop.first %} x-cloak{% endif %}>
                {% if media_type.examples|length > 1 %}
                  <div class="open-api-examples-content" x-data="{ activeExample: '{{ media_type.examples[0].identifier }}' }">
                    <div class="open-api-media-type-label">{{ media_type.name }}</div>
                    <div class="open-api-example-selector">
                      <select x-model="activeExample">
                        {% for example in media_type.examples %}
                          {%- set label = example.name or example.summary or "Example" -%}
                          <option value="{{ example.identifier }}">{{ label }}</option>
                        {% endfor %}
                      </select>
                    </div>

                    {% for example in media_type.examples %}
                      <div x-show="activeExample === '{{ example.identifier }}'"{% if not loop.first %} x-cloak{% endif %}>
                        <div class="open-api-code-block">
                          <pre data-highlight="true" class="language-json">{{ example.value }}</pre>
                        </div>
                        {% if example.description_ast %}
                          <div class="open-api-example-description">
                            {{ markdown(example.description_ast, true) }}
                          </div>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="open-api-examples-content">
                    <div class="open-api-code-block">
                      <pre data-highlight="true" class="language-json">{{ media_type.examples[0].value }}</pre>
                    </div>
                    {% if media_type.examples[0].description_ast %}
                      <div class="open-api-example-description">
                        {{ markdown(media_type.examples[0].description_ast, true) }}
                      </div>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        {# Single media type #}
        {%- set media_type = operation.request_body.media_types[0] -%}
        {% if media_type.examples and media_type.examples|length > 0 %}
          {% if media_type.examples|length > 1 %}
            <div class="open-api-examples-content" x-data="{ activeExample: '{{ media_type.examples[0].identifier }}' }">
              <div class="open-api-media-type-label">{{ media_type.name }}</div>
              <div class="open-api-example-selector">
                <select x-model="activeExample">
                  {% for example in media_type.examples %}
                    {%- set label = example.name or example.summary or "Example" -%}
                    <option value="{{ example.identifier }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>

              {% for example in media_type.examples %}
                <div x-show="activeExample === '{{ example.identifier }}'"{% if not loop.first %} x-cloak{% endif %}>
                  <div class="open-api-code-block">
                    <pre data-highlight="true" class="language-json">{{ example.value }}</pre>
                  </div>
                  {% if example.description_ast %}
                    <div class="open-api-example-description">
                      {{ markdown(example.description_ast, true) }}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="open-api-examples-content">
              <div class="open-api-code-block">
                <pre data-highlight="true" class="language-json">{{ media_type.examples[0].value }}</pre>
              </div>
              {% if media_type.examples[0].description_ast %}
                <div class="open-api-example-description">
                  {{ markdown(media_type.examples[0].description_ast, true) }}
                </div>
              {% endif %}
            </div>
          {% endif %}
        {% endif %}
      {% endif %}
    {% endif %}
  </div>
</div>
{% endif %}

{# Response Examples Section (separate component like V2) #}
{%- set has_response_examples = operation.responses and operation.responses|length > 0 and operation.responses[0].media_types and operation.responses[0].media_types[0].examples and operation.responses[0].media_types[0].examples|length > 0 -%}


{% if has_response_examples %}
<div class="open-api-response-examples">
  <h3 class="open-api-examples-title">Response examples</h3>
  
  <div class="open-api-examples-card">
    {% if operation.responses|length > 1 %}
      {# Multiple status codes - show status tabs #}
      <div x-data="{ activeStatus: '{{ operation.responses[0].code }}' }">
        <div class="open-api-examples-tabs-header">
          {% for response in operation.responses %}
            {% if response.media_types %}
              <button 
                :class="{ 'active': activeStatus === '{{ response.code }}' }" 
                @click="activeStatus = '{{ response.code }}'"
              >
                {{ response.code }}
              </button>
            {% endif %}
          {% endfor %}
        </div>

        {% for response in operation.responses %}
          {% if response.media_types %}
            {# Check if this response has any examples #}
            {%- set response_has_examples = false -%}
            {% for media_type in response.media_types %}
              {% if media_type.examples and media_type.examples|length > 0 %}
                {%- set response_has_examples = true -%}
              {% endif %}
            {% endfor %}
            
            <div x-show="activeStatus === '{{ response.code }}'"{% if not loop.first %} x-cloak{% endif %}>
              {# Status description #}
              {% if response.description_ast %}
                <div class="open-api-response-description">
                  {{ markdown(response.description_ast, true) }}
                </div>
              {% endif %}
              
              {% if response_has_examples %}
                {# Show all examples from all media types for this response #}
                <div class="open-api-examples-content">
                  {% for mt in response.media_types %}
                    {% if mt.examples and mt.examples|length > 0 %}
                      {% if mt.examples|length > 1 %}
                        <div x-data="{ activeExample: '{{ mt.examples[0].identifier }}' }">
                          <div class="open-api-example-selector">
                            <select x-model="activeExample">
                              {% for example in mt.examples %}
                                {%- set label = example.name or example.summary or "Example" -%}
                                {%- if example.name and example.summary -%}
                                  {%- set label = example.summary ~ " · " ~ example.name -%}
                                {%- elif example.summary -%}
                                  {%- set label = example.summary -%}
                                {%- endif -%}
                                <option value="{{ example.identifier }}">{{ label }}</option>
                              {% endfor %}
                            </select>
                          </div>

                          {% for example in mt.examples %}
                            <div x-show="activeExample === '{{ example.identifier }}'"{% if not loop.first %} x-cloak{% endif %}>
                              <div class="open-api-code-block">
                                <pre data-highlight="true" class="language-json">{{ example.value }}</pre>
                              </div>
                              {% if example.description_ast %}
                                <div class="open-api-example-description">
                                  {{ markdown(example.description_ast, true) }}
                                </div>
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>
                      {% else %}
                        <div class="open-api-code-block">
                          <pre data-highlight="true" class="language-json">{{ mt.examples[0].value }}</pre>
                        </div>
                        {% if mt.examples[0].description_ast %}
                          <div class="open-api-example-description">
                            {{ markdown(mt.examples[0].description_ast, true) }}
                          </div>
                        {% endif %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </div>
              {% else %}
                {# No examples available - show empty response message #}
                <div class="open-api-examples-content">
                  <p class="open-api-empty-response">Empty response</p>
                </div>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% else %}
      {# Single status code - no status tabs needed #}
      {% for response in operation.responses %}
        {% if response.media_types %}
          {# Check if this response has any examples #}
          {%- set response_has_examples = false -%}
          {% for media_type in response.media_types %}
            {% if media_type.examples and media_type.examples|length > 0 %}
              {%- set response_has_examples = true -%}
            {% endif %}
          {% endfor %}
          
          <div class="open-api-examples-content">
            {# Status description #}
            {% if response.description_ast %}
              <div class="open-api-response-description">
                {{ markdown(response.description_ast, true) }}
              </div>
            {% endif %}
            
            {% if response_has_examples %}
              {# Show all examples from all media types #}
              {% for mt in response.media_types %}
                {% if mt.examples and mt.examples|length > 0 %}
                  {% if mt.examples|length > 1 %}
                    <div x-data="{ activeExample: '{{ mt.examples[0].identifier }}' }">
                      <div class="open-api-example-selector">
                        <select x-model="activeExample">
                          {% for example in mt.examples %}
                            {%- set label = example.name or example.summary or "Example" -%}
                            {%- if example.name and example.summary -%}
                              {%- set label = example.summary ~ " · " ~ example.name -%}
                            {%- elif example.summary -%}
                              {%- set label = example.summary -%}
                            {%- endif -%}
                            <option value="{{ example.identifier }}">{{ label }}</option>
                          {% endfor %}
                        </select>
                      </div>

                      {% for example in mt.examples %}
                        <div x-show="activeExample === '{{ example.identifier }}'"{% if not loop.first %} x-cloak{% endif %}>
                          <div class="open-api-code-block">
                            <pre data-highlight="true" class="language-json">{{ example.value }}</pre>
                          </div>
                          {% if example.description_ast %}
                            <div class="open-api-example-description">
                              {{ markdown(example.description_ast, true) }}
                            </div>
                          {% endif %}
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="open-api-code-block">
                      <pre data-highlight="true" class="language-json">{{ mt.examples[0].value }}</pre>
                    </div>
                    {% if mt.examples[0].description_ast %}
                      <div class="open-api-example-description">
                        {{ markdown(mt.examples[0].description_ast, true) }}
                      </div>
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% else %}
              {# No examples available - show empty response message #}
              <p class="open-api-empty-response">Empty response</p>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>
</div>
{% endif %}